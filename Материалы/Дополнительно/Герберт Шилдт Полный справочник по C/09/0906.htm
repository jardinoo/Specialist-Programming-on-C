<HTML><HEAD>
<TITLE>Ввод / вывод при прямом доступе: функция fseek()</TITLE>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=Windows-1251"> 
<LINK REL=STYLESHEET TYPE="text/css" HREF="../work/css.css">
</HEAD><BODY>
<A href="../main.htm#09">Содержание</A> | <A href="0905.htm">&lt;&lt;&lt;</A> | <A href="0907.htm">&gt;&gt;&gt;</A><HR>
<H1>Ввод / вывод при прямом доступе: функция fseek()</H1>
<P class="tj">При прямом доступе можно выполнять операции ввода/вывода, используя систему ввода/вывода языка С и функцию <KBD>fseek()</KBD>, которая устанавливает указатель текущей позиции в файле. Вот прототип этой функции:
<PRE>int fseek(FILE *<I>уф</I>, long int <I>колич_байт</I>, int <I>начало_отсчета</I>);</PRE>
<P class="tj">Здесь <I>уф</I> — это указатель файла, возвращаемый в результате вызова функции <KBD>fopen()</KBD>, <I>колич_байт</I> — количество байтов, считая от <I>начало_отсчета</I>, оно определяет новое значение указателя текущей позиции, а <I>начало отсчёта</I> — это один из следующих макросов:
<PRE>
Начало отсчета      Макрос
Начало файла        SEEK_SET
Текущая позиция     SEEK_CUR
Конец файла         SEEK_END
</PRE>
<P class="tj">Поэтому, чтобы получить в файле доступ на расстоянии <I>колич_байт</I> байтов от начала файла, <I>начало_отсчета</I> должно равняться <KBD>SEEK_SET</KBD>. Чтобы при доступе расстояние отсчитывалось от текущей позиции, используйте макрос <KBD>SEEK_CUR</KBD>, а чтобы при доступе расстояние отсчитывалось от конца файла, нужно указывать макрос <KBD>SEEK_END</KBD>. При успешном завершении своей работы функция <KBD>fseek()</KBD> возвращает нуль, а в случае ошибки — ненулевое значение.
<P class="tj">В следующей программе показано, как используется <KBD>fseek()</KBD>. Данная программа в определенном файле отыскивает некоторый байт, а затем отображает его. В командной строке нужно указать имя файла, а затем нужный байт, то есть его расстояние в байтах от начала файла.
<PRE>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char *argv[])
{
  FILE *fp;

  if(argc!=3) {
    printf("Синтаксис: SEEK &lt;имя_файла&gt; &lt;байт&gt;\n");
    exit(1);
  }

  if((fp = fopen(argv[1], "rb"))==NULL) {
    printf("Ошибка при открытии файла.\n");
    exit(1);
  }

  if(fseek(fp, atol(argv[2]), SEEK_SET)) {
    printf("Seek error.\n");
    exit(1);
  }

  printf("В %ld-м байте содержится %c.\n", atol(argv[2]), getc(fp));
  fclose(fp);

  return 0;
}
</PRE>
<P class="tj">Функцию <KBD>fseek()</KBD> можно использовать для доступа внутри многих значений одного типа, просто умножая размер данных на номер элемента, который вам нужен. Например, предположим, имеется список рассылки, который состоит из структур типа <KBD>addr</KBD> (определенных ранее). Чтобы получить доступ к десятому адресу в файле, в котором хранятся адреса, используйте следующий оператор:
<PRE>fseek(fp, 9*sizeof(struct addr), SEEK_SET);</PRE>
<P class="tj">Текущее значение указателя текущей позиции в файле можно определить с помощью функции <KBD>ftell()</KBD>. Вот ее прототип:
<PRE>long int ftell(FILE *<I>уф</I>);</PRE>
<P class="tj">Функция возвращает текущее значение указателя текущей позиции в файле, связанном с указателем файла <I>уф</I>. При неудачном исходе она возвращает -1.
<P class="tj">Обычно прямой доступ может потребоваться лишь для двоичных файлов. Причина тут простая — так как в текстовых файлах могут выполняться преобразования символов, то может и не быть прямого соответствия между тем, что находится в файле и тем байтом, к которому нужен доступ. Единственный случай, когда надо использовать <KBD>fseek()</KBD> для текстового файла — это доступ к той позиции, которая была уже найдена с помощью <KBD>ftell()</KBD>; такой доступ выполняется с помощью макроса <KBD>SEEK_SET</KBD>, используемого в качестве начала отсчета.
<P class="tj">Хорошо помните следующее: даже если в файле находится один только текст, все равно этот файл при необходимости можно открыть и в двоичном режиме. Никакие ограничения, связанные с тем, что файлы содержат текст, к операциям прямого доступа не относятся. Эти ограничения относятся только к файлам, открытым <I>в текстовом режиме</I>.
<HR><A href="../main.htm#09">Содержание</A> | <A href="0905.htm">&lt;&lt;&lt;</A> | <A href="0907.htm">&gt;&gt;&gt;</A>
</BODY></HTML>